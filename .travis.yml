language: go

services:
  - docker

before_install:
  - echo Checking whether $TRAVIS_COMMIT_RANGE changed only docs
  - |
    if [ -z "$TRAVIS_TAG" ]; then
      git diff --name-only $TRAVIS_COMMIT_RANGE | grep -qvE '(\.md$|^(docs)/)' || {
        echo "Only docs were updated, stopping build process."
        exit
      }
    fi

script:
  - make docker_image
  - |
    if [[ "$TRAVIS_PULL_REQUEST" = "false" ]]; then
      docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD ;
      TAG=$TRAVIS_BRANCH make push_tag_image ;
    fi

after_success:
  - if [[ "$TRAVIS_BRANCH" = "master" ]]; then
    make push_image ;
    fi

before_deploy:
  - BUILD_TAG=$TRAVIS_TAG make dist
  - |
    if [[ "$TRAVIS_TAG" =~ ^v[0-9]+.[0-9]+.[0-9]+ ]]; then
      export BODY=https://github.com/second-state/devchain/blob/develop/CHANGELOG.md#${TRAVIS_TAG//.}
      export PRE=false
    elif [[ "$TRAVIS_TAG" =~ ^v ]]; then
      export BODY="release for ${TRAVIS_TAG:1}"
      export PRE=true
    else
      export BODY="release for ${TRAVIS_TAG}"
      export PRE=true
    fi

deploy:
  provider: releases
  overwrite: true
  api-key: $GITHUB_TOKEN
  skip_cleanup: true
  file_glob: true
  file: "build/dist/*"
  name: Devchain $TRAVIS_TAG
  body: $BODY
  prerelease: $PRE
  on:
    repo: second-state/devchain
    tags: true
